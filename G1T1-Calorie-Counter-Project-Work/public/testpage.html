<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard Test</title>
    <!-- Include Firebase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAhYdiPIDo0OtV-RoIiRVQCxvgofMb0js",
            authDomain: "snack-quest.firebaseapp.com",
            databaseURL: "https://snack-quest-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "snack-quest",
            storageBucket: "snack-quest.appspot.com",
            messagingSenderId: "974726219698",
            appId: "1:974726219698:web:361c5bf4bf98a8798c86ab",
            measurementId: "G-YXRNC4ZPTZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Fetch leaderboard function
        async function fetchLeaderboard(currentUserId) {
            const usersCollectionRef = collection(db, "users");
            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                console.log("Query Snapshot: ", querySnapshot); // Log query snapshot
                const users = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Document data:", data); // Log individual document data
                    users.push({ id: doc.id, ...data });
                });
                users.sort((a, b) => b.weight - a.weight);
                const top10Users = users.slice(0, 10);
                const currentUser = users.find(user => user.id === currentUserId);
                const currentUserRank = users.findIndex(user => user.id === currentUserId) + 1;
                displayLeaderboard(top10Users, currentUser, currentUserRank);
            } catch (error) {
                console.error("Error fetching users:", error);
            }
        }

        // Display leaderboard function
        function displayLeaderboard(topUsers, currentUser, currentUserRank) {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            leaderboardContainer.innerHTML = '';
            topUsers.forEach((user, index) => {
                const userEntry = document.createElement('div');
                userEntry.innerText = `${index + 1}. ${user.username}: ${user.weight} kg`;
                leaderboardContainer.appendChild(userEntry);
            });
            if (currentUser) {
                const currentUserEntry = document.createElement('div');
                currentUserEntry.innerText = `Your Rank: ${currentUserRank} - ${currentUser.username}: ${currentUser.weight} kg`;
                leaderboardContainer.appendChild(currentUserEntry);
            } else {
                const noRankEntry = document.createElement('div');
                noRankEntry.innerText = "You are not in the top 10.";
                leaderboardContainer.appendChild(noRankEntry);
            }
        }

        // Auth state change listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is authenticated:", user);  // Ensure the user is logged in
                const userId = user.uid;
                fetchLeaderboard(userId);
            } else {
                console.log("No user is logged in");
                window.location.href = "index.html"; // Redirect to login if not logged in
            }
        });

    </script>

</head>
<body>
    <div class="container">
        <h2 class="mt-5">Leaderboard</h2>
        <div id="leaderboard-container" class="mt-3"></div>
        <button id="logout-button" class="btn btn-danger mt-4">Logout</button>
    </div>

    <script>
        // Handle logout
        const logoutButton = document.getElementById('logout-button');
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = "index.html"; // Redirect to login page after logout
        });
    </script>
</body>
</html>
