<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Page</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <!-- Include Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* General Styles */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            color: #fff;
            background: linear-gradient(135deg, #2b1d5a, #a296ca, #282b75, #1d161e, #4c1c46);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            overflow-x: hidden;
        }

        h2 {
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        label {
            color: #fff;
        }

        .btn-primary {
            background-color: #4c1c46;
            border-color: #4c1c46;
        }

        .btn-primary:hover {
            background-color: #a296ca;
            border-color: #a296ca;
        }

        .form-control,
        .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #lifestyle {
            color: black;
        }

        #goals {
            color: black;
        }

        #sex {
            color: black;
        }
    </style>

</head>

<body >

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        import { fetchNutritionData } from './NutritionAPI.js';

        // Fill in with your own web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAhYdiPIDo0OtV-RoIiRVQCxvgofMb0js",
            authDomain: "snack-quest.firebaseapp.com",
            databaseURL: "https://snack-quest-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "snack-quest",
            storageBucket: "snack-quest.appspot.com",
            messagingSenderId: "974726219698",
            appId: "1:974726219698:web:361c5bf4bf98a8798c86ab",
            measurementId: "G-YXRNC4ZPTZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);  // Make sure Firestore is initialized
        const functions = getFunctions(app, "asia-southeast1");

        const registerForm = document.getElementById('registrationForm');

        const checkUsernameFunction = httpsCallable(functions, 'checkUsername');

        // Function to check if the username is taken
        async function isUsernameUnique(username) {
            try {
                console.log(username);
                const result = await checkUsernameFunction({ username });
                console.log(result)
                return result.data.available; // Returns true if available, false otherwise
            } catch (error) {
                console.error("Error checking username:", error);
                return false; // Assume the username is taken if an error occurs
            }
        }

        // Attach the checkUsername function to a button click event
        document.getElementById('check-username-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const usernameStatus = document.getElementById('username-status');

            const isUnique = await isUsernameUnique(username);
            if (isUnique) {
                usernameStatus.textContent = "Username is available";
                usernameStatus.style.color = "green";
            } else {
                usernameStatus.textContent = "Username is already taken";
                usernameStatus.style.color = "red";
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            await fetchNutritionData();

            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('username').value;
            const birthdate = document.getElementById('birthdate').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const lifestyle = document.getElementById('lifestyle').value;
            const goals = document.getElementById('goals').value;
            const breakfastTime = document.getElementById('breakfast-time').value;
            const lunchTime = document.getElementById('lunch-time').value;
            const dinnerTime = document.getElementById('dinner-time').value;

            //fields from NUtrition API
            const sex = document.getElementById('sex').value;
            const carbohydrates = document.getElementById('carbohydrates').value;
            const protein = document.getElementById('protein').value;
            const fat = document.getElementById('fat').value;
            const fiber = document.getElementById('fiber').value;
            const bmi = document.getElementById('bmi').value;
            const calorieNeeds = document.getElementById('calorieNeeds').value;

            try {
                // Check if the username is unique
                const isUnique = await isUsernameUnique(username);
                if (!isUnique) {
                    alert("Username is already taken. Please choose another one.");
                    return;
                }

                // Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;

                // Prepare user data for Firestore
                const userData = {
                    username,
                    birthdate,
                    height,
                    weight,
                    lifestyle,
                    goals,
                    mealTimes: {
                        breakfast: breakfastTime,
                        lunch: lunchTime,
                        dinner: dinnerTime
                    },
                    sex,            // NutritionAPI fields
                    carbohydrates,
                    protein,
                    fat,
                    fiber,
                    bmi,
                    calorieNeeds
                };

                // Save user data to Firestore
                await setDoc(doc(db, "users", userId), userData);
                alert('Registration successful! Redirecting to the main page.');
                window.location.href = "3DVersion.html";
            } catch (error) {
                console.error("Error during registration:", error);
                alert(error.message);
            }
        });
    </script>



    <div class="container mt-5">
        <h2 class="text-center">Registration Form</h2>
        <p>Already have an account? <a href="index.html" id="show-login">Login here</a></p>

        <form id="registrationForm">
            <!-- Username -->
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" placeholder="Enter a username" required>
                <button type="button" class="btn btn-secondary mt-2" id="check-username-btn">Check Username</button>
                <div id="username-status" class="form-text mt-2"></div>
            </div>
            <!-- email -->
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="register-email" placeholder="Email" required>
            </div>

            <!-- Password -->
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="register-password" placeholder="Enter a password"
                    required>
            </div>

            <!-- Reconfirm Password -->
            <div class="mb-3">
                <label for="reconfirm-password" class="form-label">Reconfirm Password</label>
                <input type="password" class="form-control" id="reconfirm-password" placeholder="Re-enter your password"
                    required>
                <div id="passwordHelp" class="form-text text-danger"></div>
            </div>

            <!-- Gender -->
            <div class="mb-3">
                <label for="sex" class="form-label">Gender</label>
                <select class="form-select" id="sex" required>
                    <option selected disabled>Select your Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>

            <!-- Birth Date -->
            <div class="mb-3">
                <label for="birthdate" class="form-label">Birth Date</label>
                <input type="date" class="form-control" id="birthdate" required>
            </div>

            <!-- Calculated Age -->
            <div class="mb-3">
                <label for="calculated-age" class="form-label">Your Age</label>
                <div id="calculated-age" class="form-control"></div>
                <input type="hidden" id="currentAge" name="currentAge" value="">
            </div>

            <!-- Height -->
            <div class="mb-3">
                <label for="height" class="form-label">Height (cm)</label>
                <input type="number" class="form-control" id="height" placeholder="Enter your height in cm" required>
            </div>

            <!-- Weight -->
            <div class="mb-3">
                <label for="weight" class="form-label">Weight (kg)</label>
                <input type="number" class="form-control" id="weight" placeholder="Enter your weight in kg" required>
            </div>

            <!-- Lifestyle -->
            <div class="mb-3">
                <label for="lifestyle" class="form-label">Lifestyle</label>
                <select class="form-select" id="lifestyle" required>
                    <option selected disabled>Select your lifestyle</option>
                    <option value="Inactive">Sedentary (little or no exercise)</option>
                    <option value="Low Active">Light (exercise 1-3 times per week)</option>
                    <option value="Active">Moderate (exercise 3-5 times per week)</option>
                    <option value="Very Active">Active (daily exercise or intense exercise 3-4 times per week)</option>
                </select>
            </div>

            <!-- Fitness Goals -->
            <div class="mb-3">
                <label for="goals" class="form-label">Fitness Goals</label>
                <select class="form-select" id="goals" required>
                    <option selected disabled>Select your fitness goal</option>
                    <option value="diet">Diet</option>
                    <option value="gain muscle">Gain Muscle</option>
                    <option value="increase endurance">Increase Endurance</option>
                </select>
            </div>

            <!-- Usual Mealtimes -->
            <div class="mb-3">
                <label for="mealtimes" class="form-label">Usual Mealtimes</label>
                <div class="row">
                    <div class="col">
                        <label for="breakfast-time" class="form-label">Breakfast</label>
                        <input type="time" class="form-control" id="breakfast-time" required>
                    </div>
                    <div class="col">
                        <label for="lunch-time" class="form-label">Lunch</label>
                        <input type="time" class="form-control" id="lunch-time" required>
                    </div>
                    <div class="col">
                        <label for="dinner-time" class="form-label">Dinner</label>
                        <input type="time" class="form-control" id="dinner-time" required>
                    </div>
                </div>
            </div>
            <!--I added these fields so NutritionAPI can populate it-->
            <input type="hidden" id="carbohydrates" name="carbohydrates">
            <input type="hidden" id="protein" name="protein">
            <input type="hidden" id="fat" name="fat">
            <input type="hidden" id="fiber" name="fiber">
            <input type="hidden" id="bmi" name="bmi">
            <input type="hidden" id="calorieNeeds" name="calorieNeeds">

            <!-- Submit Button -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript for Calculating Age -->
    <script>
        const birthdateField = document.getElementById('birthdate');
        const calculatedAgeDiv = document.getElementById('calculated-age');
        const currentAge = document.getElementById('currentAge');

        birthdateField.addEventListener('input', () => {
            const birthdate = new Date(birthdateField.value);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }

            calculatedAgeDiv.textContent = `You are ${age} years old.`;
            currentAge.value = age;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>

</html>