<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module" src="/scripts/logout.js"></script>
  <style>
    /* Add your custom styles here */
    .page-container {
      padding: 10px;
      overflow: hidden; /* Prevents overlap */
      padding-bottom: 120px; /* Adds extra space at the bottom */
    }

    .chart-container {
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .icon {
      font-size: 30px;
      margin-bottom: 10px;
    }

    .chart-container {
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* Ensure space between elements */
    }

    .info-card {
      margin-top: 10px; /* Add spacing between elements */
      white-space: nowrap; /* Prevent text from wrapping unnecessarily */
    }

    .typing-area {
      margin-top: 40px; /* Adds space between the charts and form */
      display: flex;
      justify-content: center; /* Centers the form */
      align-items: center;
      position: relative; /* Ensures proper flow of content */
    }

    .typing-input {
      width: 300px; /* Adjust width of the input box */
      margin-right: 10px; /* Space between input and button */
    }

    button.icon {
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>

<body id="app">

  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Snack Quest</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="#">üåü Home</a></li>
          <li class="nav-item"><a class="nav-link" href="leaderboard.html">üèÜ Leaderboard</a></li>
          <li class="nav-item"><a class="nav-link active" href="foodnearby.html">üçΩÔ∏è Food Nearby</a></li>
          <li class="nav-item"><a class="nav-link active" href="history.html">üìú History</a></li>
          <li class="nav-item"><a class="nav-link" href="account.html">üë§ Account</a></li>
        </ul>
      </div>
      <button class="btn btn-danger ms-3" id="logout-button">Logout</button>
    </div>
  </nav>

  <div class="page-container">
    <div class="page">
      <h2 class="text-center">Current Progress</h2>
      <div class="row">
        <div class="col-12 col-md-6 col-lg-3">
          <div class="chart-container" id="caloriesContainer">
            <canvas id="caloriesChart"></canvas>
            <div class="icon">Calories ‚ö°</div>
            <div class="info-card"></div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="chart-container" id="carbsContainer">
            <canvas id="carbsChart"></canvas>
            <div class="icon">Carbohydrates ü•ñ</div>
            <div class="info-card"></div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="chart-container" id="proteinContainer">
            <canvas id="proteinChart"></canvas>
            <div class="icon">Protein üçñ</div>
            <div class="info-card"></div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="chart-container" id="fatsContainer">
            <canvas id="fatsChart"></canvas>
            <div class="icon">Fats üßà</div>
            <div class="info-card"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meal Input Section -->
    <!-- <div class="mt-4">
      <label for="meal-time">What time is this meal (Breakfast, Lunch, Dinner)?</label>
      <input type="text" id="meal-time" placeholder="e.g., Breakfast" class="form-control">
      <label for="title" class="mt-2">What is the name of the food you ate?</label>
      <input type="text" id="title" placeholder="e.g., Fresh Ham Roasted With Rye Bread" class="form-control">
      <label for="ingredients" class="mt-2">List the ingredients (separated by commas):</label>
      <input type="text" id="ingredients" placeholder="e.g., 1 fresh ham, 7 cloves garlic, 1 tablespoon olive oil" class="form-control">
      <button type="button" class="btn btn-primary mt-3" onclick="makeCorsRequest()">Submit</button>
      <pre id="response" class="mt-2"></pre>
    </div> -->
  </div>
  <div>
    <!-- Typing Area -->
    <div class="typing-area">
        <form action="#" class="typing-form">
            <div class="input-wrapper">
                <input type="text" placeholder="What have you eaten?" class="typing-input" required><br>
                <label for="meal-time">Select Meal Time:</label>
                  <select id="meal-time" name="meal-time" class="form-control">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="others">Others</option>
                  </select>
                <button class="icon material-symbols-rounded">send</button>
            </div>
        </form>
    </div>

    <!-- Chat List / Container -->
    <div class="chat-list">
      <!-- dynamically appendchild -->
    </div>

    <script src="../scripts/NakedGeminiNutritionWrapper2.js"></script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Chart.js Configuration -->
  <script>
    const targets = {
      calories: 2500,
      carbs: 300,
      protein: 50,
      fats: 70
    };

    const initialConsumption = {
      calories: 0,
      carbs: 0,
      protein: 0,
      fats: 0
    };

    // Initialize charts with default values
    function initCharts() {
      updateDonutChart('caloriesChart', initialConsumption.calories, targets.calories, '#FF6384');
      updateDonutChart('carbsChart', initialConsumption.carbs, targets.carbs, '#36A2EB');
      updateDonutChart('proteinChart', initialConsumption.protein, targets.protein, '#FFCE56');
      updateDonutChart('fatsChart', initialConsumption.fats, targets.fats, '#4BC0C0');
    }

    function updateDonutChart(chartId, consumed, total, color) {
      const ctx = document.getElementById(chartId).getContext('2d');
      const remaining = Math.max(0, total - consumed);

      // Destroy existing chart if it exists
      const existingChart = Chart.getChart(chartId);
      if (existingChart) {
        existingChart.destroy();
      }

      // Create new chart
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Consumed', 'Remaining'],
          datasets: [{
            data: [consumed, remaining],
            backgroundColor: [color, '#CCCCCC']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Update the info card
      const container = document.getElementById(chartId.replace('Chart', 'Container'));
      const infoCard = container.querySelector('.info-card');
      infoCard.innerHTML = 
        `<p><strong>Total needed today:</strong> ${total} ${getUnit(chartId)}</p>
         <p><strong>Consumed today:</strong> ${consumed.toFixed(2)} ${getUnit(chartId)}</p>`;
    }

    // Helper function to get the appropriate unit for each nutrient
    function getUnit(chartId) {
      switch (chartId) {
        case 'caloriesChart':
          return 'kcal';
        default:
          return 'grams';
      }
    }

    // Function to update all charts with new data
    function updateAllCharts(nutritionData) {
      const newConsumption = {
        calories: initialConsumption.calories + parseFloat(nutritionData.calories),
        carbs: initialConsumption.carbs + parseFloat(nutritionData.carbohydrates),
        protein: initialConsumption.protein + parseFloat(nutritionData.protein),
        fats: initialConsumption.fats + parseFloat(nutritionData.fats)
      };

      // Update each chart with new values
      updateDonutChart('caloriesChart', newConsumption.calories, targets.calories, '#FF6384');
      updateDonutChart('carbsChart', newConsumption.carbs, targets.carbs, '#36A2EB');
      updateDonutChart('proteinChart', newConsumption.protein, targets.protein, '#FFCE56');
      updateDonutChart('fatsChart', newConsumption.fats, targets.fats, '#4BC0C0');

      // Save updated consumption data for future reference
      localStorage.setItem('nutritionData', JSON.stringify(newConsumption));
    }

    // Call the init function on page load
    window.onload = initCharts;
  </script>

  <!-- To display the response from the API -->
  <pre id="response"></pre>

  <script>
    const app_id = "a9117ed0";
    const app_key = "8cce3f9bebdcc9fef5243e23387c0bc0";

    // Create the XHR object.
    function createCORSRequest(method, url) {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest != "undefined") {
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        xhr = null;
      }
      return xhr;
    }

    // Validate user inputs
    function validateInputs(title, ingredients, mealTime) {
      if (mealTime.trim() === '') {
        alert('Please enter the meal time (e.g., Breakfast).');
        return false;
      }
      if (title.trim() === '') {
        alert('Please enter the name of the food.');
        return false;
      }
      if (ingredients.length === 0 || ingredients[0].trim() === '') {
        alert('Please enter at least one ingredient.');
        return false;
      }
      return true;
    }

    // Make the actual CORS request.
    function makeCorsRequest() {
      let mealTime = document.getElementById('meal-time').value;
      let title = document.getElementById('title').value;
      let ingredients = document.getElementById('ingredients').value.split(',');

      if (!validateInputs(title, ingredients, mealTime)) {
        return; // Stop execution if validation fails
      }

      let recipeData = {
        "title": title,
        "yield": "1 serving",
        "ingr": ingredients.map(item => item.trim())
      };

      let pre = document.getElementById('response');
      var url = 'https://api.edamam.com/api/nutrition-details?app_id=' + app_id + '&app_key=' + app_key;

      var xhr = createCORSRequest('POST', url);
      if (!xhr) {
        alert('CORS not supported');
        return;
      }

      // Response handler
      xhr.onload = function () {
        var response = JSON.parse(xhr.responseText);
        if (response.totalNutrients) {
          let nutritionData = {
            calories: response.totalNutrients.ENERC_KCAL ? response.totalNutrients.ENERC_KCAL.quantity : 0,
            carbohydrates: response.totalNutrients.CHOCDF ? response.totalNutrients.CHOCDF.quantity : 0,
            protein: response.totalNutrients.PROCNT ? response.totalNutrients.PROCNT.quantity : 0,
            fats: response.totalNutrients.FAT ? response.totalNutrients.FAT.quantity : 0
          };

          updateAllCharts(nutritionData);
          localStorage.setItem('mealData', JSON.stringify(recipeData)); // Save the data for Card.html

          // Display nutrition data in the response area
          pre.innerHTML = `Calories: ${nutritionData.calories} kcal\nCarbohydrates: ${nutritionData.carbohydrates} g\nProtein: ${nutritionData.protein} g\nFats: ${nutritionData.fats} g`;
        } else {
          pre.innerHTML = 'No nutrition information found.';
        }
      };

      xhr.onerror = function () {
        alert('Error making the request. Please try again.');
      };

      pre.innerHTML = 'Loading...'; // Show loading text while waiting for response
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(recipeData)); // Send the recipe data to the API
    }
  </script>

</body>

</html>
